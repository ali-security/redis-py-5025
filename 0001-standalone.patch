From 4161cd80ee3cec9670c594b09368e2c46a00aa90 Mon Sep 17 00:00:00 2001
From: Aaron Belenky <aaron.b@sealsecurity.io>
Date: Thu, 7 Aug 2025 17:50:21 +0300
Subject: [PATCH] standalone

---
 dev_requirements.txt       |  4 +++-
 docker/redismod/Dockerfile | 44 ++++++++++++++++++++++++++++++++++++++
 tox.ini                    |  4 +++-
 3 files changed, 50 insertions(+), 2 deletions(-)
 create mode 100644 docker/redismod/Dockerfile

diff --git a/dev_requirements.txt b/dev_requirements.txt
index 31ae26eb..50c58486 100644
--- a/dev_requirements.txt
+++ b/dev_requirements.txt
@@ -8,10 +8,12 @@ pytest==6.2.5
 pytest-timeout==2.0.1
 pytest-asyncio>=0.16.0
 tox==3.24.4
-tox-docker==3.1.0
+tox-docker==4.1.0
 invoke==1.6.0
 pytest-cov>=3.0.0
 vulture>=2.3.0
 ujson>=4.2.0
 wheel>=0.30.0
 uvloop
+async-timeout==5.0.1
+requests=== 2.31.0 # https://github.com/ansible-collections/community.docker/issues/868#issuecomment-2124979976
\ No newline at end of file
diff --git a/docker/redismod/Dockerfile b/docker/redismod/Dockerfile
new file mode 100644
index 00000000..0ca16c65
--- /dev/null
+++ b/docker/redismod/Dockerfile
@@ -0,0 +1,44 @@
+ARG REDIS_VER=6.2.6
+ARG ARCH=x64
+ARG OSNICK=bullseye
+
+FROM redislabs/redisai:latest as redisai
+FROM redislabs/redisearch:2.6.7 as redisearch
+FROM redislabs/redisgraph:2.10.2 as redisgraph
+FROM redislabs/redistimeseries:1.8.2 as redistimeseries
+FROM redislabs/rejson:2.4.6 as rejson
+FROM redislabs/rebloom:latest as rebloom
+FROM redislabs/redisgears:latest as redisgears
+FROM redisfab/redis:${REDIS_VER}-${ARCH}-${OSNICK}
+
+ENV LD_LIBRARY_PATH /usr/lib/redis/modules
+ENV REDISGEARS_MODULE_DIR /var/opt/redislabs/lib/modules
+ENV REDISGEARS_PY_DIR /var/opt/redislabs/modules/rg
+ENV REDISGRAPH_DEPS libgomp1 git
+
+WORKDIR /data
+RUN apt-get update -qq
+RUN apt-get upgrade -y
+RUN apt-get install -y --no-install-recommends ${REDISGRAPH_DEPS};
+RUN rm -rf /var/cache/apt
+
+COPY --from=redisai ${LD_LIBRARY_PATH}/redisai.so ${LD_LIBRARY_PATH}/
+COPY --from=redisai ${LD_LIBRARY_PATH}/backends ${LD_LIBRARY_PATH}/backends
+COPY --from=redisearch ${LD_LIBRARY_PATH}/redisearch.so ${LD_LIBRARY_PATH}/
+COPY --from=redisgraph ${LD_LIBRARY_PATH}/redisgraph.so ${LD_LIBRARY_PATH}/
+COPY --from=redistimeseries ${LD_LIBRARY_PATH}/*.so ${LD_LIBRARY_PATH}/
+COPY --from=rejson ${LD_LIBRARY_PATH}/*.so ${LD_LIBRARY_PATH}/
+COPY --from=rebloom ${LD_LIBRARY_PATH}/*.so ${LD_LIBRARY_PATH}/
+COPY --from=redisgears --chown=redis:redis ${REDISGEARS_MODULE_DIR}/redisgears.so ${LD_LIBRARY_PATH}/
+COPY --from=redisgears --chown=redis:redis ${REDISGEARS_PY_DIR}/ ${REDISGEARS_PY_DIR}/
+
+# ENV PYTHONPATH /usr/lib/redis/modules/deps/cpython/Lib
+ENTRYPOINT ["redis-server", "--port", "6379"]
+CMD ["--loadmodule", "/usr/lib/redis/modules/redisai.so", \
+    "--loadmodule", "/usr/lib/redis/modules/redisearch.so", \
+    "--loadmodule", "/usr/lib/redis/modules/redisgraph.so", \
+    "--loadmodule", "/usr/lib/redis/modules/redistimeseries.so", \
+    "--loadmodule", "/usr/lib/redis/modules/rejson.so", \
+    "--loadmodule", "/usr/lib/redis/modules/redisbloom.so", \
+    "--loadmodule", "/usr/lib/redis/modules/redisgears.so", \
+    "Plugin", "/var/opt/redislabs/modules/rg/plugin/gears_python.so"]
diff --git a/tox.ini b/tox.ini
index 0ceb008c..08d597c6 100644
--- a/tox.ini
+++ b/tox.ini
@@ -93,7 +93,9 @@ volumes =
 
 [docker:redismod]
 name = redismod
-image = redislabs/redismod:edge
+image = redismod_old
+# build using:
+# cd docker/redismod && docker build . -t redismod_old
 ports =
     36379:6379/tcp
 healtcheck_cmd = python -c "import socket;print(True) if 0 == socket.socket(socket.AF_INET, socket.SOCK_STREAM).connect_ex(('127.0.0.1',36379)) else False"
-- 
2.39.5 (Apple Git-154)

